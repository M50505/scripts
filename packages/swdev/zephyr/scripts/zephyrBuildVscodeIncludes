#!/usr/bin/env bash
# vim:tabstop=2:shiftwidth=2:nu:filetype=sh
#	
# Author:              Martin Cribbins
# Revision history:
#
# 2026-02-07 - Initial version.
#	
#_doc ${1} 20260207122944 " " && exit 0

#optInit
#optAdd sample string "test"  "A sample string option"
#optAdd input string ""  "The input file to use."
#optAdd output string ""  "The output file to use."
#optAdd mark boolean false "A sample boolean option"
#optParse $* 
#optParseSuccess || exit 1


#[[ -n ${input} ]] && exec 0<${input}
#[[ -n ${output} ]] && exec 1>${output}

# This script extracts and filters -I and -isystem and -imacros C/CPP command line arguments 
#	from a log of a zephyr build result, using sed.
#	The command line arguments are then piped to sort -u for de-duplication, and then piped
#	to sed one last time to substitute occurrences of the current Zephyr project root and the
#	current vscode project directory into ${env:ZEPHYR_PROJECT_ROOT} ... and ${workspaceFolder}
#	instances.
#
#	The resulting text is translated into an entry for the vscode project's c_cpp_properties.json file.
#	

if [[ -z ${ZEPHYR_PROJECT_ROOT} ]]
then
	msgError <<EOF
The ZEPHYR_PROJECT_ROOT environment variable must be set. This variable points to
the installation directory of the desired version of Zephyr-RTOS.
EOF

	exit 1
fi

if [[ $# -lt 1 ]]
then
	msgError << EOF
You must specify a log file, which captured the *successful* build of your project.
The west command should include the '-vvv' option in this case, in order to ensure
that the full list of include command line options that were used for C/CPP were captured.
EOF

	exit 1
fi

if [[ ! -f "${1}" ]]
then
	msgError The log file ${1} cannot be found.

	exit 1
fi

logFile="${1}"

sed -rn "
	/-I/ {
		s/-I/\n-I/g
		
		p
	}

	/-isystem/ {
		s/-isystem/\n-isystem/g
		p
	}

	/-imacros/ {
		s/-imacros/\n-imacros/g
		p
	}
" ${logFile} | sed -rn "

/^-I/	{
	s/(-I\S+).*$/\1/
	p
}

/^ZZZ-isystem/	{
	s/(-isystem\s\S+).*$/\1/
	p
}

/^ZZZ-imacros/	{
	s/(-imacros\s\S+).*$/\1/
	p
}" | \
sort -u | \
sed -r "
	s,${ZEPHYR_PROJECT_ROOT},\${env:ZEPHYR_PROJECT_ROOT},g

	s/-I(.+$)/\"\1\",/
"
