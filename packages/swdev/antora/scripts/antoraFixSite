#!/usr/bin/env bash
# vim:tabstop=2:shiftwidth=2:nu:filetype=sh
#	
# Author:              Martin Cribbins
# Revision history:
#
# 2025-05-15 - Initial version.
#	
#_doc ${1} 20250515150101 " " && exit 0

#
#	This is the directory that Antora creates under which
#	the bulk of the content is placed. By default Antora
#	uses the name "documentation", which is why the
# newRootDirectory defaults to that name if it is not
# provided on the command line.
#
#	The root directory can be specified for Antora by setting
#	the value of the site:->url: key in the antora playbook
# file (which by default is named "antora-playbook.yml" .
#

newRootDirectory="${1:-/documentation}"
localDir="$(basename ${newRootDirectory})"

if [[ ! -d "${localDir}" ]]
then
	cat <<EOF >&2
The directory named "${localDir}" is not in this directory,
indicating that we may not be in the correct location from which to
run this script.

You want to be in the directory that is generated by Antora named "site"
and then run this script again.
EOF

	exit 1
fi

#
#	Step 1:
#
#	Move the _ directory, as well as the 404.html and search-index.js files
# into the new root directory
#
rm index.html
[[ -f 404.html ]] && mv 404.html ${localDir}
mv _ ${localDir}
mv search-index.js ${localDir}

#
#	Step 2:
#
#	Convert all href= references in HTML file which are relatively specifying
#	either "../" or "../../" into absolute references, substituting each
#	indirect reference into href="/<newRootDirectory>" where <newRootDirectory>
#	is the new root directory specified above.
#
#	The sed command is used, -r indicating posix regular expressions and -i indicating
#	that eac affected file is to be updated in place. THe find command creates the list
#	of HTML files for sed to operate on.
#
	htmlFiles=$(find . -name \*.html)

	set -x
	sed -r -i "{
		s,src=\"../_,src=\"${newRootDirectory}/_,g	
		s,src=\"../../_,src=\"${newRootDirectory}/_,g	
		s,src=\"../../search-index.js,src=\"${newRootDirectory}/search-index.js,g	
		
		s,stylesheet=\"../_,stylesheet=\"${newRootDirectory}/_,g	
		s,stylesheet=\"../../_,stylesheet=\"${newRootDirectory}/_,g	

		s,href=\"../_,href=\"${newRootDirectory}/_,g	
		s,href=\"../../_,href=\"${newRootDirectory}/_,g	
		s,href=\"./\",href=\"${newRootDirectory}/\",g	
		s,href=\"..\",href=\"${newRootDirectory}\",g	
		s,href=\"../,href=\"${newRootDirectory}/,g	
		s,href=\"([^/]),href=\"${newRootDirectory}/\1,g	

		s,href=\"(.+)/\",href=\"\1/index.html\",g	
	}" ${htmlFiles}

